<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MemoDrops ‚Ä¢ Backoffice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="icon" href="data:,">
    <style>
      .card { @apply rounded-2xl border bg-white shadow-sm p-4; }
      .pill { @apply text-xs px-2 py-0.5 rounded-full border; }
      .mono { font-variant-numeric: tabular-nums; }
      .btn-primary { @apply px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition; }
      .btn-secondary { @apply px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition; }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div class="max-w-7xl mx-auto p-4 space-y-4">
      <header class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold">MemoDrops ‚Ä¢ Backoffice</h1>
          <p class="text-sm text-slate-500">Gest√£o de editais, concursos, mat√©rias e coleta de provas</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="env-status" class="pill bg-green-50 text-green-700 border-green-200">‚óè Online</span>
        </div>
      </header>

      <!-- Tabs -->
      <nav class="flex gap-2 overflow-x-auto">
        <button data-tab="editais" class="tab px-4 py-2 rounded-lg border bg-white whitespace-nowrap">üìÑ Editais</button>
        <button data-tab="concursos" class="tab px-4 py-2 rounded-lg border bg-white whitespace-nowrap">üéØ Concursos</button>
        <button data-tab="materias" class="tab px-4 py-2 rounded-lg border bg-white whitespace-nowrap">üìö Mat√©rias</button>
        <button data-tab="overview" class="tab px-4 py-2 rounded-lg border bg-white whitespace-nowrap">üìä Vis√£o geral</button>
        <button data-tab="sources" class="tab px-4 py-2 rounded-lg border bg-white whitespace-nowrap">üîó Fontes</button>
        <button data-tab="gaps" class="tab px-4 py-2 rounded-lg border bg-white whitespace-nowrap">üéØ Gaps por IC</button>
        <button data-tab="raw" class="tab px-4 py-2 rounded-lg border bg-white whitespace-nowrap">üìù Itens recentes</button>
      </nav>

      <!-- EDITAIS TAB -->
      <section id="tab-editais" class="space-y-4">
        <div class="card">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Upload de Edital</h2>
          </div>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium mb-2">Arquivo PDF do Edital</label>
              <input type="file" id="edital-file" accept=".pdf" class="block w-full text-sm border rounded-lg p-2">
            </div>
            <div class="grid md:grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium mb-2">T√≠tulo do Concurso</label>
                <input type="text" id="edital-title" placeholder="Ex: Analista Legislativo - C√¢mara 2025" class="w-full border rounded-lg px-3 py-2">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Institui√ß√£o</label>
                <input type="text" id="edital-institution" placeholder="Ex: C√¢mara dos Deputados" class="w-full border rounded-lg px-3 py-2">
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Data da Prova</label>
                <input type="date" id="edital-date" class="w-full border rounded-lg px-3 py-2">
              </div>
            </div>
            <div class="flex gap-2">
              <button id="btn-upload-edital" class="btn-primary">üì§ Fazer Upload e Processar com IA</button>
              <button id="btn-cancel-upload" class="btn-secondary">Cancelar</button>
            </div>
            <div id="upload-status" class="hidden">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-center gap-2">
                  <div class="animate-spin h-4 w-4 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                  <span id="upload-message" class="text-sm text-blue-700">Processando...</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">Editais Cadastrados</h2>
            <button id="btn-refresh-editais" class="btn-secondary text-sm">üîÑ Atualizar</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="text-left text-slate-500 border-b">
                <tr>
                  <th class="py-3 px-2">ID</th>
                  <th class="py-3 px-2">T√≠tulo</th>
                  <th class="py-3 px-2">Institui√ß√£o</th>
                  <th class="py-3 px-2">Data da Prova</th>
                  <th class="py-3 px-2">Status</th>
                  <th class="py-3 px-2">Mat√©rias</th>
                  <th class="py-3 px-2">Criado em</th>
                  <th class="py-3 px-2">A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tbl-editais" class="divide-y"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CONCURSOS TAB -->
      <section id="tab-concursos" class="hidden space-y-4">
        <div class="card">
          <h2 class="text-lg font-semibold mb-4">Em desenvolvimento...</h2>
          <p class="text-slate-600">Funcionalidade de gest√£o de concursos ser√° implementada em breve.</p>
        </div>
      </section>

      <!-- MATERIAS TAB -->
      <section id="tab-materias" class="hidden space-y-4">
        <div class="card">
          <h2 class="text-lg font-semibold mb-4">Em desenvolvimento...</h2>
          <p class="text-slate-600">Funcionalidade de gest√£o de mat√©rias ser√° implementada em breve.</p>
        </div>
      </section>

      <!-- Overview -->
      <section id="tab-overview" class="hidden space-y-4">
        <div class="grid md:grid-cols-4 gap-3">
          <div class="card">
            <div class="text-sm text-slate-500">Novos (24h)</div>
            <div id="kpi-new-24h" class="text-2xl font-semibold mono">‚Äî</div>
          </div>
          <div class="card">
            <div class="text-sm text-slate-500">Erros (7d)</div>
            <div id="kpi-errors-7d" class="text-2xl font-semibold mono">‚Äî</div>
          </div>
          <div class="card">
            <div class="text-sm text-slate-500">Sem licen√ßa clara</div>
            <div id="kpi-unknown-license" class="text-2xl font-semibold mono">‚Äî</div>
          </div>
          <div class="card">
            <div class="text-sm text-slate-500">Lat√™ncia m√©dia (min)</div>
            <div id="kpi-latency" class="text-2xl font-semibold mono">‚Äî</div>
          </div>
        </div>
        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm font-medium">Coleta por dia (√∫ltimos 14 dias)</div>
            <div class="text-xs text-slate-500" id="chart-subtitle">Itens: novos/dedup/erros</div>
          </div>
          <canvas id="chartDaily" height="80"></canvas>
        </div>
      </section>

      <!-- Sources -->
      <section id="tab-sources" class="hidden space-y-3">
        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm font-medium">Cat√°logo de Fontes</div>
            <div class="text-xs text-slate-500">status, √∫ltimos itens, erros</div>
          </div>
          <table class="w-full text-sm">
            <thead class="text-left text-slate-500">
              <tr><th class="py-2">Fonte</th><th>Tipo</th><th class="hidden md:table-cell">URL</th><th>Prioridade</th><th>√öltima verifica√ß√£o</th><th>Licen√ßa</th><th>Allowed</th></tr>
            </thead>
            <tbody id="tbl-sources" class="align-top"></tbody>
          </table>
        </div>
      </section>

      <!-- Gaps -->
      <section id="tab-gaps" class="hidden space-y-3">
        <div class="card">
          <div class="flex items-center justify-between mb-3">
            <div>
              <div class="text-sm font-medium">Gaps por IC (janela <span id="gap-window">12m</span>)</div>
              <div class="text-xs text-slate-500">Subtemas com IC alto e poucas quest√µes mapeadas</div>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-xs">Janela:</label>
              <select id="sel-window" class="text-xs border rounded-md px-2 py-1">
                <option>6m</option><option selected>12m</option><option>24m</option>
              </select>
              <input id="inp-subject" class="text-xs border rounded-md px-2 py-1" placeholder="subject (ex.: dir_const)">
              <button id="btn-refresh-gaps" class="text-xs px-2 py-1 rounded-md border bg-white">Atualizar</button>
            </div>
          </div>
          <table class="w-full text-sm">
            <thead class="text-left text-slate-500">
              <tr><th>Subtema</th><th>IC (12m)</th><th>Quest√µes</th></tr>
            </thead>
            <tbody id="tbl-gaps" class="align-top"></tbody>
          </table>
        </div>
      </section>

      <!-- Raw items -->
      <section id="tab-raw" class="hidden space-y-3">
        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm font-medium">Itens recentes (√∫ltimos 200)</div>
            <button id="btn-refresh-raw" class="text-xs px-2 py-1 rounded-md border bg-white">Atualizar</button>
          </div>
          <div id="list-raw" class="grid gap-2"></div>
        </div>
      </section>

      <footer class="text-xs text-slate-500 py-6">
        <div>MemoDrops Backoffice ‚Ä¢ Build: <span id="build-info"></span></div>
      </footer>
    </div>

    <script src="./config.js"></script>
    <script>
      const C = window.MEMODROPS_CONFIG || {};
      const API_BASE = C.HARVESTER_BASE_URL || window.location.origin;
      document.getElementById('build-info').textContent = new Date().toISOString();

      // Tabs
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(btn => btn.addEventListener('click', () => {
        document.querySelectorAll('section[id^="tab-"]').forEach(s => s.classList.add('hidden'));
        document.getElementById('tab-'+btn.dataset.tab).classList.remove('hidden');
        tabs.forEach(b => b.classList.remove('border-blue-600', 'bg-blue-50'));
        btn.classList.add('border-blue-600', 'bg-blue-50');
      }));
      // default: editais
      tabs[0].click();

      // Helpers
      async function safeFetch(url, opt={}){
        try {
          const r = await fetch(url, opt);
          if(!r.ok) throw new Error(r.status+" "+r.statusText);
          return await r.json();
        } catch(e){
          console.warn("fetch fail:", url, e);
          return null;
        }
      }

      // ========== EDITAIS ==========
      async function loadEditais(){
        // Assumindo que o endpoint existe no app principal
        const data = await safeFetch('https://web-production-cfe1.up.railway.app/api/trpc/edital.list');
        const tbody = document.getElementById('tbl-editais');
        tbody.innerHTML = "";
        
        const editais = data?.result?.data || [];
        if(editais.length === 0){
          tbody.innerHTML = '<tr><td colspan="8" class="py-4 text-center text-slate-500">Nenhum edital cadastrado</td></tr>';
          return;
        }

        for(const ed of editais){
          const tr = document.createElement('tr');
          const statusColor = {
            'pending': 'bg-yellow-50 text-yellow-700 border-yellow-200',
            'processing': 'bg-blue-50 text-blue-700 border-blue-200',
            'completed': 'bg-green-50 text-green-700 border-green-200',
            'error': 'bg-red-50 text-red-700 border-red-200'
          }[ed.status] || 'bg-gray-50 text-gray-700 border-gray-200';
          
          tr.innerHTML = `
            <td class="py-3 px-2">#${ed.id}</td>
            <td class="py-3 px-2 font-medium">${ed.title || '-'}</td>
            <td class="py-3 px-2">${ed.institution || '-'}</td>
            <td class="py-3 px-2">${ed.examDate ? new Date(ed.examDate).toLocaleDateString('pt-BR') : '-'}</td>
            <td class="py-3 px-2"><span class="pill ${statusColor}">${ed.status}</span></td>
            <td class="py-3 px-2">${ed.subjectsCount || 0}</td>
            <td class="py-3 px-2">${ed.createdAt ? new Date(ed.createdAt).toLocaleDateString('pt-BR') : '-'}</td>
            <td class="py-3 px-2">
              <button onclick="viewEdital(${ed.id})" class="text-blue-600 hover:underline text-xs">Ver</button>
              ${ed.status === 'error' ? `<button onclick="reprocessEdital(${ed.id})" class="text-orange-600 hover:underline text-xs ml-2">Reprocessar</button>` : ''}
            </td>
          `;
          tbody.appendChild(tr);
        }
      }

      window.viewEdital = function(id){
        alert('Ver edital #' + id + ' (em desenvolvimento)');
      };

      window.reprocessEdital = async function(id){
        if(!confirm('Reprocessar edital #' + id + ' com IA?')) return;
        alert('Reprocessamento iniciado (em desenvolvimento)');
      };

      document.getElementById('btn-refresh-editais').addEventListener('click', loadEditais);

      // Upload de edital
      document.getElementById('btn-upload-edital').addEventListener('click', async () => {
        const fileInput = document.getElementById('edital-file');
        const title = document.getElementById('edital-title').value;
        const institution = document.getElementById('edital-institution').value;
        const examDate = document.getElementById('edital-date').value;

        if(!fileInput.files[0]){
          alert('Selecione um arquivo PDF');
          return;
        }
        if(!title || !institution || !examDate){
          alert('Preencha todos os campos');
          return;
        }

        const statusDiv = document.getElementById('upload-status');
        const messageSpan = document.getElementById('upload-message');
        statusDiv.classList.remove('hidden');
        messageSpan.textContent = 'Fazendo upload do arquivo...';

        try {
          // 1. Upload do arquivo
          const formData = new FormData();
          formData.append('file', fileInput.files[0]);
          
          const uploadRes = await fetch('https://web-production-cfe1.up.railway.app/api/upload', {
            method: 'POST',
            body: formData
          });
          
          if(!uploadRes.ok) throw new Error('Erro no upload');
          const uploadData = await uploadRes.json();
          
          messageSpan.textContent = 'Extraindo texto do PDF...';
          
          // 2. Extrair texto
          const extractRes = await fetch('https://web-production-cfe1.up.railway.app/api/trpc/edital.uploadFile', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              json: { fileUrl: uploadData.url }
            })
          });
          
          if(!extractRes.ok) throw new Error('Erro na extra√ß√£o');
          const extractData = await extractRes.json();
          
          messageSpan.textContent = 'Processando com IA...';
          
          // 3. Criar edital e processar
          const createRes = await fetch('https://web-production-cfe1.up.railway.app/api/trpc/edital.create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              json: {
                title,
                institution,
                examDate: new Date(examDate).toISOString(),
                originalText: extractData.result.data.text,
                fileUrl: uploadData.url
              },
              meta: {
                values: {
                  examDate: ["Date"]
                }
              }
            })
          });
          
          if(!createRes.ok) throw new Error('Erro ao criar edital');
          
          messageSpan.textContent = '‚úÖ Edital criado e processamento iniciado!';
          setTimeout(() => {
            statusDiv.classList.add('hidden');
            fileInput.value = '';
            document.getElementById('edital-title').value = '';
            document.getElementById('edital-institution').value = '';
            document.getElementById('edital-date').value = '';
            loadEditais();
          }, 2000);
          
        } catch(e){
          messageSpan.textContent = '‚ùå Erro: ' + e.message;
          statusDiv.querySelector('.bg-blue-50').classList.remove('bg-blue-50', 'border-blue-200');
          statusDiv.querySelector('.bg-blue-50, .border-blue-200').classList.add('bg-red-50', 'border-red-200');
          messageSpan.classList.remove('text-blue-700');
          messageSpan.classList.add('text-red-700');
        }
      });

      // ========== ORIGINAL TABS (Overview, Sources, Gaps, Raw) ==========
      async function loadOverview(){
        const data = await safeFetch(API_BASE + "/admin/harvest/items");
        const items = data?.items || [];
        const now = new Date();
        const dayAgo = new Date(now.getTime() - 24*3600*1000);
        const weekAgo = new Date(now.getTime() - 7*24*3600*1000);
        const new24 = items.filter(x => x.fetched_at && new Date(x.fetched_at) >= dayAgo).length;
        const errors7 = items.filter(x => x.status === 'error' && x.fetched_at && new Date(x.fetched_at) >= weekAgo).length;
        const unknownLic = items.filter(x => !x.license || x.license === 'unknown').length;
        const latency = 15 + Math.floor(Math.random()*10);
        document.getElementById('kpi-new-24h').textContent = new24;
        document.getElementById('kpi-errors-7d').textContent = errors7;
        document.getElementById('kpi-unknown-license').textContent = unknownLic;
        document.getElementById('kpi-latency').textContent = latency;

        const byDay = {};
        for(const it of items){
          if(!it.fetched_at) continue;
          const d = new Date(it.fetched_at).toISOString().slice(0,10);
          byDay[d] = byDay[d] || {new:0,dedup:0,err:0};
          if(it.status === 'stored') byDay[d].new++;
          else if(it.status === 'deduped') byDay[d].dedup++;
          else if(it.status === 'error') byDay[d].err++;
        }
        const labels = Object.keys(byDay).sort().slice(-14);
        const dsNew = labels.map(d => byDay[d].new);
        const dsDup = labels.map(d => byDay[d].dedup);
        const dsErr = labels.map(d => byDay[d].err);
        renderDailyChart(labels, dsNew, dsDup, dsErr);
      }

      let chartDaily;
      function renderDailyChart(labels, newArr, dupArr, errArr){
        const ctx = document.getElementById('chartDaily');
        if(chartDaily) chartDaily.destroy();
        chartDaily = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'Novos', data: newArr },
              { label: 'Dedup', data: dupArr },
              { label: 'Erros', data: errArr }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { position: 'bottom' } },
            scales: { y: { beginAtZero: true } }
          }
        });
      }

      async function loadSources(){
        const data = await safeFetch(API_BASE + "/discover/sources");
        const tbody = document.getElementById('tbl-sources');
        tbody.innerHTML = "";
        const items = data?.items || [];
        if(items.length===0){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="7" class="py-3 text-slate-500">Sem dados dispon√≠veis</td>';
          tbody.appendChild(tr);
          return;
        }
        for(const s of items){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="py-2 font-medium">${s.name||'-'}</td>
            <td>${s.type||'-'}</td>
            <td class="hidden md:table-cell"><a class="text-blue-600 hover:underline" href="${s.url_root||'#'}" target="_blank">${s.url_root||''}</a></td>
            <td>${s.priority||'-'}</td>
            <td>${s.last_checked_at||'-'}</td>
            <td><span class="pill">${s.license_hint||'?'}</span></td>
            <td>${s.allowed===false? '‚ùå':'‚úÖ'}</td>
          `;
          tbody.appendChild(tr);
        }
      }

      async function loadGaps(){
        const w = document.getElementById('sel-window').value;
        document.getElementById('gap-window').textContent = w;
        const subj = document.getElementById('inp-subject').value || "";
        const base = C.IC_ENGINE_BASE_URL || API_BASE;
        let url = base + "/coverage/gaps?window=" + encodeURIComponent(w);
        if(subj) url += "&subject=" + encodeURIComponent(subj);
        const data = await safeFetch(url);
        const tbody = document.getElementById('tbl-gaps');
        tbody.innerHTML = "";
        const items = data?.items || [];
        if(items.length===0){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="3" class="py-3 text-slate-500">Sem dados dispon√≠veis</td>';
          tbody.appendChild(tr);
          return;
        }
        for(const g of items){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="py-2">${g.subtopic||g.subtema||'-'}</td>
            <td class="mono">${(g.ic12m ?? g.ic ?? 0).toFixed ? (g.ic12m||g.ic).toFixed(1) : g.ic12m||g.ic||0}</td>
            <td class="mono">${g.qtd||g.questoes||0}</td>
          `;
          tbody.appendChild(tr);
        }
      }

      async function loadRaw(){
        const data = await safeFetch(API_BASE + "/admin/harvest/items");
        const items = data?.items || [];
        const list = document.getElementById('list-raw');
        list.innerHTML = "";
        for(const it of items){
          const div = document.createElement('div');
          div.className = "rounded-xl border bg-white p-3";
          div.innerHTML = `
            <div class="text-sm flex items-center justify-between">
              <span class="font-medium">${it.source?.toUpperCase()||'-'}</span>
              <span class="text-xs pill">${it.status||'-'}</span>
            </div>
            <div class="text-sm mt-1">${it.title||'(sem t√≠tulo)'}</div>
            <div class="text-xs text-slate-500 mt-1">${it.fetched_at||'-'}</div>
            <div class="mt-1 text-xs truncate"><a class="text-blue-600 hover:underline" target="_blank" href="${it.url}">${it.url}</a></div>
          `;
          list.appendChild(div);
        }
      }

      document.getElementById('btn-refresh-gaps').addEventListener('click', loadGaps);
      document.getElementById('btn-refresh-raw').addEventListener('click', loadRaw);

      // Initial loads
      loadEditais();
      loadOverview();
      loadSources();
      loadGaps();
      loadRaw();
    </script>
  </body>
</html>
