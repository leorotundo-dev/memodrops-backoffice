<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MemoDrops ‚Ä¢ Backoffice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:,">
    <style>
      .card { @apply rounded-2xl border bg-white shadow-sm p-6; }
      .pill { @apply text-xs px-2 py-0.5 rounded-full border; }
      .mono { font-variant-numeric: tabular-nums; }
      .btn-primary { @apply px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition; }
      .btn-secondary { @apply px-4 py-2 border border-slate-300 rounded-lg hover:bg-slate-50 transition; }
      .btn-sm { @apply px-3 py-1 text-sm; }
      .folder-card {
        @apply card cursor-pointer hover:shadow-md hover:border-blue-300 transition-all;
      }
      .folder-card:hover {
        transform: translateY(-2px);
      }
      .breadcrumb-item {
        @apply flex items-center gap-2 text-slate-600 hover:text-blue-600 cursor-pointer transition;
      }
      .breadcrumb-item:last-child {
        @apply text-slate-900 font-medium cursor-default;
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div class="max-w-7xl mx-auto p-4 space-y-4">
      
      <!-- Header -->
      <header class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold">MemoDrops ‚Ä¢ Backoffice</h1>
          <p class="text-sm text-slate-500">Gest√£o hier√°rquica de conte√∫do educacional</p>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="showUtilityTab('harvester')" class="btn-secondary btn-sm">ü§ñ Harvester</button>
          <button onclick="showUtilityTab('stats')" class="btn-secondary btn-sm">üìä Estat√≠sticas</button>
          <button onclick="showUtilityTab('costs')" class="btn-secondary btn-sm">üí∞ Custos</button>
          <span id="env-status" class="pill bg-green-50 text-green-700 border-green-200">‚óè Online</span>
        </div>
      </header>

      <!-- Breadcrumb Navigation -->
      <nav id="breadcrumb" class="flex items-center gap-2 text-sm">
        <div class="breadcrumb-item" onclick="navigateTo('home')">
          <span>üè†</span>
          <span>In√≠cio</span>
        </div>
      </nav>

      <!-- Main Content Area -->
      <main id="main-content" class="space-y-4">
        <!-- Conte√∫do din√¢mico ser√° inserido aqui -->
      </main>

      <!-- Utility Tabs (Harvester, Stats, Costs) -->
      <div id="utility-panel" class="hidden space-y-4">
        <div class="flex items-center justify-between">
          <h2 id="utility-title" class="text-xl font-bold"></h2>
          <button onclick="hideUtilityPanel()" class="btn-secondary btn-sm">‚úï Fechar</button>
        </div>
        <div id="utility-content"></div>
      </div>

    </div>

    <script>
      // ========================================
      // ESTADO DA NAVEGA√á√ÉO
      // ========================================
      const state = {
        level: 'categories',  // categories | contests | editals | subjects | topics | subtopics
        categoryId: null,
        categoryName: null,
        contestId: null,
        contestName: null,
        editalId: null,
        editalName: null,
        subjectId: null,
        subjectName: null,
        topicId: null,
        topicName: null
      };

      // ========================================
      // NAVEGA√á√ÉO
      // ========================================
      function navigateTo(level, id = null, name = null) {
        // Atualizar estado
        state.level = level;
        
        // Resetar n√≠veis inferiores
        if (level === 'home' || level === 'categories') {
          state.categoryId = null;
          state.categoryName = null;
          state.contestId = null;
          state.contestName = null;
          state.editalId = null;
          state.editalName = null;
          state.subjectId = null;
          state.subjectName = null;
          state.topicId = null;
          state.topicName = null;
        } else if (level === 'contests') {
          state.categoryId = id;
          state.categoryName = name;
          state.contestId = null;
          state.contestName = null;
          state.editalId = null;
          state.editalName = null;
          state.subjectId = null;
          state.subjectName = null;
          state.topicId = null;
          state.topicName = null;
        } else if (level === 'editals') {
          state.contestId = id;
          state.contestName = name;
          state.editalId = null;
          state.editalName = null;
          state.subjectId = null;
          state.subjectName = null;
          state.topicId = null;
          state.topicName = null;
        } else if (level === 'subjects') {
          state.editalId = id;
          state.editalName = name;
          state.subjectId = null;
          state.subjectName = null;
          state.topicId = null;
          state.topicName = null;
        } else if (level === 'topics') {
          state.subjectId = id;
          state.subjectName = name;
          state.topicId = null;
          state.topicName = null;
        } else if (level === 'subtopics') {
          state.topicId = id;
          state.topicName = name;
        }

        // Renderizar
        renderBreadcrumb();
        renderContent();
      }

      function renderBreadcrumb() {
        const breadcrumb = document.getElementById('breadcrumb');
        let html = '<div class="breadcrumb-item" onclick="navigateTo(\'categories\')"><span>üè†</span><span>In√≠cio</span></div>';

        if (state.categoryId) {
          html += '<span class="text-slate-400">‚Ä∫</span>';
          html += `<div class="breadcrumb-item" onclick="navigateTo('contests', ${state.categoryId}, '${state.categoryName}')"><span>üìÇ</span><span>${state.categoryName}</span></div>`;
        }

        if (state.contestId) {
          html += '<span class="text-slate-400">‚Ä∫</span>';
          html += `<div class="breadcrumb-item" onclick="navigateTo('editals', ${state.contestId}, '${state.contestName}')"><span>üéØ</span><span>${state.contestName}</span></div>`;
        }

        if (state.editalId) {
          html += '<span class="text-slate-400">‚Ä∫</span>';
          html += `<div class="breadcrumb-item" onclick="navigateTo('subjects', ${state.editalId}, '${state.editalName}')"><span>üìÑ</span><span>${state.editalName}</span></div>`;
        }

        if (state.subjectId) {
          html += '<span class="text-slate-400">‚Ä∫</span>';
          html += `<div class="breadcrumb-item" onclick="navigateTo('topics', ${state.subjectId}, '${state.subjectName}')"><span>üìö</span><span>${state.subjectName}</span></div>`;
        }

        if (state.topicId) {
          html += '<span class="text-slate-400">‚Ä∫</span>';
          html += `<div class="breadcrumb-item"><span>üìù</span><span>${state.topicName}</span></div>`;
        }

        breadcrumb.innerHTML = html;
      }

      function renderContent() {
        const main = document.getElementById('main-content');
        
        switch(state.level) {
          case 'categories':
            renderCategories();
            break;
          case 'contests':
            renderContests();
            break;
          case 'editals':
            renderEditals();
            break;
          case 'subjects':
            renderSubjects();
            break;
          case 'topics':
            renderTopics();
            break;
          case 'subtopics':
            renderSubtopics();
            break;
        }
      }

      // ========================================
      // RENDERIZA√á√ÉO DE CADA N√çVEL
      // ========================================
      async function renderCategories() {
        const main = document.getElementById('main-content');
        main.innerHTML = '<div class="card"><p class="text-center text-slate-500">Carregando categorias...</p></div>';

        try {
          const res = await fetch('/api/categories');
          const data = await res.json();
          const categories = data.categories || data;

          let html = '<div class="card">';
          html += '<div class="flex items-center justify-between mb-6">';
          html += '<h2 class="text-xl font-semibold">Categorias de Objetivos</h2>';
          html += '<button onclick="addCategory()" class="btn-primary btn-sm">+ Nova Categoria</button>';
          html += '</div>';
          html += '<div class="grid md:grid-cols-3 gap-4">';

          categories.forEach(cat => {
            html += `
              <div class="folder-card" onclick="navigateTo('contests', ${cat.id}, '${cat.name}')">
                <div class="text-4xl mb-2">${cat.icon || 'üìÇ'}</div>
                <div class="font-semibold text-lg">${cat.name}</div>
                <div class="text-sm text-slate-500 mt-1">${cat.description || ''}</div>
                <div class="text-xs text-slate-400 mt-2">${cat.contests_count || 0} concursos</div>
              </div>
            `;
          });

          html += '</div></div>';
          main.innerHTML = html;
        } catch (err) {
          main.innerHTML = '<div class="card"><p class="text-red-600">Erro ao carregar categorias</p></div>';
        }
      }

      async function renderContests() {
        const main = document.getElementById('main-content');
        main.innerHTML = '<div class="card"><p class="text-center text-slate-500">Carregando concursos...</p></div>';

        try {
          const res = await fetch(`/api/contests?category_id=${state.categoryId}`);
          const data = await res.json();
          const contests = data.contests || data;

          let html = '<div class="card">';
          html += '<div class="flex items-center justify-between mb-6">';
          html += `<h2 class="text-xl font-semibold">Concursos de ${state.categoryName}</h2>`;
          html += '<button onclick="addContest()" class="btn-primary btn-sm">+ Novo Concurso</button>';
          html += '</div>';
          html += '<div class="grid md:grid-cols-2 gap-4">';

          contests.forEach(contest => {
            html += `
              <div class="folder-card" onclick="navigateTo('editals', ${contest.id}, '${contest.title}')">
                <div class="flex items-start justify-between">
                  <div class="text-3xl">üéØ</div>
                  <span class="pill ${contest.status === 'active' ? 'bg-green-50 text-green-700 border-green-200' : 'bg-gray-50 text-gray-700 border-gray-200'}">${contest.status}</span>
                </div>
                <div class="font-semibold text-lg mt-2">${contest.title}</div>
                <div class="text-sm text-slate-500 mt-1">${contest.institution || ''}</div>
                <div class="flex items-center gap-4 text-xs text-slate-400 mt-3">
                  <span>üìÑ ${contest.editals_count || 0} editais</span>
                  <span>üìÖ ${new Date(contest.created_at).toLocaleDateString('pt-BR')}</span>
                </div>
              </div>
            `;
          });

          if (contests.length === 0) {
            html += '<div class="col-span-2 text-center text-slate-500 py-8">Nenhum concurso cadastrado nesta categoria</div>';
          }

          html += '</div></div>';
          main.innerHTML = html;
        } catch (err) {
          main.innerHTML = '<div class="card"><p class="text-red-600">Erro ao carregar concursos</p></div>';
        }
      }

      async function renderEditals() {
        const main = document.getElementById('main-content');
        main.innerHTML = '<div class="card"><p class="text-center text-slate-500">Carregando editais...</p></div>';

        try {
          const res = await fetch(`/api/editals?contest_id=${state.contestId}`);
          const data = await res.json();
          const editals = data.editals || data;

          let html = '<div class="card">';
          html += '<div class="flex items-center justify-between mb-6">';
          html += `<h2 class="text-xl font-semibold">Editais de ${state.contestName}</h2>`;
          html += '<button onclick="addEdital()" class="btn-primary btn-sm">+ Novo Edital</button>';
          html += '</div>';
          html += '<div class="space-y-3">';

          editals.forEach(edital => {
            html += `
              <div class="folder-card flex items-center justify-between" onclick="navigateTo('subjects', ${edital.id}, '${edital.title}')">
                <div class="flex items-center gap-4">
                  <div class="text-3xl">üìÑ</div>
                  <div>
                    <div class="font-semibold">${edital.title}</div>
                    <div class="text-sm text-slate-500">N¬∫ ${edital.edital_number || 'N/A'}</div>
                    <div class="text-xs text-slate-400 mt-1">
                      üìö ${edital.subjects_count || 0} mat√©rias ‚Ä¢ 
                      üìÖ ${new Date(edital.created_at).toLocaleDateString('pt-BR')}
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  ${edital.file_url ? '<button onclick="event.stopPropagation(); window.open(\'/uploads/\' + \'' + edital.file_url + '\', \'_blank\')" class="btn-secondary btn-sm">üìé PDF</button>' : ''}
                  <button onclick="event.stopPropagation(); uploadEdital(${edital.id})" class="btn-secondary btn-sm">üì§ Upload</button>
                </div>
              </div>
            `;
          });

          if (editals.length === 0) {
            html += '<div class="text-center text-slate-500 py-8">Nenhum edital cadastrado neste concurso</div>';
          }

          html += '</div></div>';
          main.innerHTML = html;
        } catch (err) {
          main.innerHTML = '<div class="card"><p class="text-red-600">Erro ao carregar editais</p></div>';
        }
      }

      async function renderSubjects() {
        const main = document.getElementById('main-content');
        main.innerHTML = '<div class="card"><p class="text-center text-slate-500">Carregando mat√©rias...</p></div>';

        try {
          const res = await fetch(`/api/subjects?edital_id=${state.editalId}`);
          const data = await res.json();
          const subjects = data.subjects || data;

          let html = '<div class="card">';
          html += '<div class="flex items-center justify-between mb-6">';
          html += `<h2 class="text-xl font-semibold">Mat√©rias do ${state.editalName}</h2>`;
          html += '<button onclick="addSubject()" class="btn-primary btn-sm">+ Nova Mat√©ria</button>';
          html += '</div>';
          html += '<div class="grid md:grid-cols-3 gap-4">';

          subjects.forEach(subject => {
            html += `
              <div class="folder-card" onclick="navigateTo('topics', ${subject.id}, '${subject.name}')">
                <div class="text-3xl mb-2">üìö</div>
                <div class="font-semibold">${subject.name}</div>
                <div class="text-xs text-slate-400 mt-2">üìù ${subject.topics_count || 0} t√≥picos</div>
              </div>
            `;
          });

          if (subjects.length === 0) {
            html += '<div class="col-span-3 text-center text-slate-500 py-8">Nenhuma mat√©ria cadastrada neste edital</div>';
          }

          html += '</div></div>';
          main.innerHTML = html;
        } catch (err) {
          main.innerHTML = '<div class="card"><p class="text-red-600">Erro ao carregar mat√©rias</p></div>';
        }
      }

      async function renderTopics() {
        const main = document.getElementById('main-content');
        main.innerHTML = '<div class="card"><p class="text-center text-slate-500">Carregando t√≥picos...</p></div>';

        try {
          const res = await fetch(`/api/topics?subject_id=${state.subjectId}`);
          const data = await res.json();
          const topics = data.topics || data;

          let html = '<div class="card">';
          html += '<div class="flex items-center justify-between mb-6">';
          html += `<h2 class="text-xl font-semibold">T√≥picos de ${state.subjectName}</h2>`;
          html += '<button onclick="addTopic()" class="btn-primary btn-sm">+ Novo T√≥pico</button>';
          html += '</div>';
          html += '<div class="space-y-2">';

          topics.forEach(topic => {
            html += `
              <div class="folder-card flex items-center justify-between" onclick="navigateTo('subtopics', ${topic.id}, '${topic.title}')">
                <div class="flex items-center gap-3">
                  <div class="text-2xl">üìù</div>
                  <div>
                    <div class="font-semibold">${topic.title}</div>
                    <div class="text-xs text-slate-400">üîπ ${topic.subtopics_count || 0} subt√≥picos</div>
                  </div>
                </div>
              </div>
            `;
          });

          if (topics.length === 0) {
            html += '<div class="text-center text-slate-500 py-8">Nenhum t√≥pico cadastrado nesta mat√©ria</div>';
          }

          html += '</div></div>';
          main.innerHTML = html;
        } catch (err) {
          main.innerHTML = '<div class="card"><p class="text-red-600">Erro ao carregar t√≥picos</p></div>';
        }
      }

      async function renderSubtopics() {
        const main = document.getElementById('main-content');
        main.innerHTML = '<div class="card"><p class="text-center text-slate-500">Carregando subt√≥picos...</p></div>';

        try {
          const res = await fetch(`/api/subtopics?topic_id=${state.topicId}`);
          const data = await res.json();
          const subtopics = data.subtopics || data;

          let html = '<div class="card">';
          html += '<div class="flex items-center justify-between mb-6">';
          html += `<h2 class="text-xl font-semibold">Subt√≥picos de ${state.topicName}</h2>`;
          html += '<button onclick="addSubtopic()" class="btn-primary btn-sm">+ Novo Subt√≥pico</button>';
          html += '</div>';
          html += '<div class="space-y-2">';

          subtopics.forEach(subtopic => {
            html += `
              <div class="card">
                <div class="flex items-center gap-3">
                  <div class="text-xl">üîπ</div>
                  <div class="font-medium">${subtopic.title}</div>
                </div>
              </div>
            `;
          });

          if (subtopics.length === 0) {
            html += '<div class="text-center text-slate-500 py-8">Nenhum subt√≥pico cadastrado neste t√≥pico</div>';
          }

          html += '</div></div>';
          main.innerHTML = html;
        } catch (err) {
          main.innerHTML = '<div class="card"><p class="text-red-600">Erro ao carregar subt√≥picos</p></div>';
        }
      }

      // ========================================
      // UTILITY TABS
      // ========================================
      function showUtilityTab(tab) {
        document.getElementById('main-content').classList.add('hidden');
        // Manter breadcrumb vis√≠vel para acesso ao In√≠cio
        document.getElementById('utility-panel').classList.remove('hidden');
        
        const title = document.getElementById('utility-title');
        const content = document.getElementById('utility-content');

        if (tab === 'harvester') {
          title.textContent = 'ü§ñ Harvester';
          content.innerHTML = '<p class="text-slate-500">Conte√∫do do Harvester (implementar)</p>';
        } else if (tab === 'stats') {
          title.textContent = 'üìä Estat√≠sticas';
          content.innerHTML = '<p class="text-slate-500">Conte√∫do de Estat√≠sticas (implementar)</p>';
        } else if (tab === 'costs') {
          title.textContent = 'üí∞ Custos';
          loadCosts();
        }
      }

      function hideUtilityPanel() {
        document.getElementById('main-content').classList.remove('hidden');
        // Breadcrumb j√° est√° vis√≠vel
        document.getElementById('utility-panel').classList.add('hidden');
      }

      async function loadCosts() {
        const content = document.getElementById('utility-content');
        content.innerHTML = '<p class="text-slate-500">Carregando custos...</p>';

        try {
          const res = await fetch('/api/costs/metrics');
          const data = await res.json();

          let html = '<div class="grid md:grid-cols-4 gap-4 mb-6">';
          html += `<div class="card"><div class="text-sm text-slate-500">Custo Mensal Total</div><div class="text-2xl font-bold mono">R$ ${data.monthly.total.toFixed(2)}</div></div>`;
          html += `<div class="card"><div class="text-sm text-slate-500">OpenAI API</div><div class="text-2xl font-bold mono">R$ ${(data.openai.estimatedCost * 5.5).toFixed(2)}</div></div>`;
          html += `<div class="card"><div class="text-sm text-slate-500">Railway Hosting</div><div class="text-2xl font-bold mono">R$ ${data.railway.currentUsage.toFixed(2)}</div></div>`;
          html += `<div class="card"><div class="text-sm text-slate-500">Armazenamento</div><div class="text-2xl font-bold mono">${(data.storage.database + data.storage.files).toFixed(1)} MB</div></div>`;
          html += '</div>';

          content.innerHTML = html;
        } catch (err) {
          content.innerHTML = '<p class="text-red-600">Erro ao carregar custos</p>';
        }
      }

      // ========================================
      // A√á√ïES (PLACEHOLDERS)
      // ========================================
      function addCategory() { alert('Adicionar categoria (em desenvolvimento)'); }
      function addContest() { alert('Adicionar concurso (em desenvolvimento)'); }
      function addEdital() { alert('Adicionar edital (em desenvolvimento)'); }
      function addSubject() { alert('Adicionar mat√©ria (em desenvolvimento)'); }
      function addTopic() { alert('Adicionar t√≥pico (em desenvolvimento)'); }
      function addSubtopic() { alert('Adicionar subt√≥pico (em desenvolvimento)'); }
      function uploadEdital(id) { alert('Upload de edital ' + id + ' (em desenvolvimento)'); }

      // ========================================
      // INICIALIZA√á√ÉO
      // ========================================
      document.addEventListener('DOMContentLoaded', () => {
        navigateTo('categories');
      });
    </script>
  </body>
</html>
